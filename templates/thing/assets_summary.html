{% extends "base.html" %}
{% load url from future %}
{% load thing_extras %}
{% import 'macros/icons.html' as icons %}

{% block title %}Assets{% endblock %}

{% block extra_js %}
    <script type="text/javascript">
      var characters = new Array();
      {% for character in characters.values() %}characters[{{ loop.index0 }}] = new Array({{ character.id }}, "{{ character.name|safe }}");
      {% endfor -%}
      characters.sort(function(a, b) { return a[1] > b[1] });

      var corporations = new Array();
      {% for corporation in corporations.values() %}corporations[{{ loop.index0 }}] = new Array({{ corporation.id }}, "{{ corporation.name|safe }}");
      {% endfor -%}
      corporations.sort(function(a, b) { return a[1] > b[1] });

      var selected = new Array();
      {% for ft, fc, fv in filters %}
      {% if fv %}selected[{{ loop.index0 }}] = {{ fv }};{% endif %}
      {% endfor -%}

      // bind value loader to type boxes
      $('#filters').on('change', '.filter-type', function() {
        $select = $(this).nextAll('.filter-value:first');
        $select.empty();

        var $v = $(this).val();
        if ($v == 'char') {
          for (i = 0; i < characters.length; i++) {
            $select.append($('<option>', { value: characters[i][0] }).text(characters[i][1]));
          }
        }
        else if ($v == 'corp') {
          for (i = 0; i < corporations.length; i++) {
            $select.append($('<option>', { value: corporations[i][0] }).text(corporations[i][1]));
          }
        }
        else {
          $select.append($('<option>', { value: '' }).text(''));
        }
      });

      // trigger each one to force an update
      $('.filter-type').each(function() {
        $(this).change();
      })

      // set them to the correct values
      var i = 0;
      $('.filter-value').each(function() {
        $(this).val(selected[i]);
        i++;
      });

      // bind the asset expander buttons
      $(".asset-expand").on('click', function() {
        var $this = $(this);
        
        if ($this.hasClass('icon-chevron-right')) {
          $this.addClass('icon-chevron-down').removeClass('icon-chevron-right');
          $($this.attr('data-target')).show();
        }
        else {
          $this.addClass('icon-chevron-right').removeClass('icon-chevron-down');
          $($this.attr('data-target')).hide();
        }
      });
    </script>
{% endblock %}

{% block content %}
      <div id="filters" class="row-fluid">
        <div class="span12">
          <h2>Assets</h2>

          <form class="well well-small" action="{% url 'thing.views.assets_filter' %}" method="GET">
            <h4>Filters</h4>
            <fieldset>
              {% for f_type, f_comp, f_value in filters -%}
              <select name="type" class="filter-type input-medium">
                <option value=""></option>
                <option value="char"{% if f_type == 'char' %} selected{% endif %}>Character</option>
                {% if corporations|length -%}
                <option value="corp"{% if f_type == 'corp' %} selected{% endif %}>Corporation</option>
                {%- endif %}
              </select>
              <select name="comp" class="input-small">
                <option value="eq"{% if f_comp == 'eq' %} selected{% endif %}>=</option>
                <option value="ne"{% if f_comp == 'ne' %} selected{% endif %}>!=</option>
              </select>
              <select name="value" class="filter-value input-xlarge">
                <option value=""></option>
              </select>
              {%- endfor %}
            </fieldset>
            <button type="submit" class="btn btn-primary">Apply filters</button>
            <a href="{% url 'thing.views.assets_filter' %}" class="btn btn-danger">Clear filters</a>
          </form>
        </div>
      </div>

      <div class="row-fluid">
        <div class="span3" id="sidenav">
          <ul class="nav nav-list assets-sidenav span3" data-spy="affix" data-offset-top="100">
            <li><a href="#total"><i class="icon-chevron-right"></i> Total</a></li>
            {%- if characters %}
            <li class="divider"></li>
            {%- for character in characters.values() %}
            <li><a href="#{{ character.id }}"><i class="icon-chevron-right"></i> {{ character.name }}</a></li>
            {%- endfor %}
            {%- endif %}
            {%- if corporations %}
            <li class="divider"></li>
            {%- for corporation in corporations.values() %}
            <li><a href="#{{ corporation.id }}"><i class="icon-chevron-right"></i> {{ corporation.name }}</a></li>
            {%- endfor %}
            {%- endif %}
          </ul>
        </div>

        <div class="span9 anchor" id="total">
          <table class="table table-striped table-bordered table-condensed">
            <thead>
              <tr class="c">
                <th>Location</th>
                <th>Items</th>
                <th>Volume</th>
                <th>Value</th>
              </tr>
            </thead>
            <tbody>
              <tr class="r">
                <td class="l">[All locations]</td>
                <td>{{ overall_total['items']|commas }}</td>
                <td>{{ overall_total.volume|commas }}m<sup>3</sup></td>
                <td>{{ overall_total.value|commas }}</td>
              </tr>
              {%- for (system, station), totals in total_data %}
              <tr{#{% if system_changed %} class="divider-row"{% endif %}#}>
                <td>
                  {% if station %}{{ station }}{% else %}{{ system }}{% endif %}
                </td>
                <td class="r">{{ totals['items']|commas }}</td>
                <td class="r">{{ totals.volume|commas }}m<sup>3</sup></td>
                <td class="r">{{ totals.value|commas }}</td>
              </tr>
              {%- endfor %}
            </tbody>
          </table>
        </div>
      </div>

      {%- for (corp_name, char_name), summary_data in summary_list %}
      <div class="anchor" id="{{ summary_data.0.2.corporation_id|default(summary_data.0.2.character.id) }}"></div>
      <div class="row-fluid">
        <div class="span9 offset3">
          <table class="table table-striped table-bordered table-condensed">
            <caption>{{ corp_name|default(char_name) }}</caption>
            <thead>
              <tr class="c">
                <th>Location</th>
                <th>Items</th>
                <th>Volume</th>
                <th>Value</th>
              </tr>
            </thead>
            <tbody>
              {%- for system_name, station_name, summary in summary_data %}
              <tr>
                <td>
                  {%- if station_name %}
                  <a href="{% url 'thing.views.assets_filter' %}?ft=char&fc=eq&fv={{ summary.character.id }}&ft=station&fc=eq&fv={{ summary.station.id }}">
                    {{ station_name }}
                  </a>
                  {%- else %}
                  <a href="{% url 'thing.views.assets_filter' %}?ft=char&fc=eq&fv={{ summary.character.id }}&ft=system&fc=eq&fv={{ summary.system.id }}">
                    {{ system_name }}
                  </a>
                  {%- endif %}
                </td>
                <td class="r">{{ summary.total_items|commas }}</td>
                <td class="r">{{ summary.total_volume|commas }}m<sup>3</sup></td>
                <td class="r">{{ summary.total_value|commas }}</td>
              </tr>
              {%- endfor %}
            </tbody>
          </table>
        </div>
      </div>
      {%- endfor %}
{% endblock %}
